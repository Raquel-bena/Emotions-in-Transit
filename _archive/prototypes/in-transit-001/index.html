<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>MelodÃ­as Emocionales con Tone.js</title>
    <script src="https://unpkg.com/tone@14.9.15/build/Tone.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 50px; background-color: #f4f4f9; }
        h1 { color: #333; }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        #btn-alegria { background-color: #4CAF50; color: white; }
        #btn-tristeza { background-color: #2196F3; color: white; }
        #btn-miedo { background-color: #FF9800; color: white; }
        #btn-enojo { background-color: #F44336; color: white; }
        #btn-calma { background-color: #00BCD4; color: white; }
        #btn-stop { background-color: #9E9E9E; color: white; }
    </style>
</head>
<body>

    <h1>Generador de Tracks Emocionales (Tone.js)</h1>
    <p>Haz clic en una emociÃ³n para escuchar su melodÃ­a:</p>

    <div>
        <button id="btn-alegria" onclick="playEmotionTrack('alegria')">ðŸ˜ƒ AlegrÃ­a</button>
        <button id="btn-tristeza" onclick="playEmotionTrack('tristeza')">ðŸ˜” Tristeza</button>
        <button id="btn-miedo" onclick="playEmotionTrack('miedo')">ðŸ˜¨ Miedo</button>
        <button id="btn-enojo" onclick="playEmotionTrack('enojo')">ðŸ˜  Enojo</button>
        <button id="btn-calma" onclick="playEmotionTrack('calma')">ðŸ˜Œ Calma</button>
        <button id="btn-stop" onclick="stopAll()">â—¼ Detener</button>
    </div>

    <script>
        let currentTrack = null;
        let activeSynths = [];

        // FunciÃ³n para inicializar el contexto de audio
        const startAudioContext = async () => {
            if (Tone.context.state !== 'running') {
                await Tone.start();
                console.log("Audio Context Started.");
            }
        };

        // FunciÃ³n para detener el track actual y limpiar los sintetizadores
        const stopAll = () => {
            Tone.Transport.stop();
            if (currentTrack) {
                currentTrack.dispose();
                currentTrack = null;
            }
            activeSynths.forEach(synth => synth.dispose());
            activeSynths = [];
            console.log("ReproducciÃ³n detenida y sintetizadores limpiados.");
        };

        // === FUNCIONES DE MELODÃA ===

        // 1. ðŸ˜ƒ AlegrÃ­a (Joy) - RÃ¡pido, brillante, staccato
        const createAlegriaTrack = () => {
            Tone.Transport.bpm.value = 150;
            const synth = new Tone.Synth({
                envelope: {
                    attack: 0.01,
                    decay: 0.2,
                    sustain: 0.1,
                    release: 0.5
                },
                oscillator: { type: 'triangle' }
            }).toDestination();
            activeSynths.push(synth);

            const melody = [
                ["C4", "E4", "G4", "C5"],
                ["G4", "F4", "E4", "D4"],
                ["E4", "G4", "A4", "G4"],
                ["F4", "E4", "D4", "C4"]
            ];
            
            const part = new Tone.Part((time, chord) => {
                // Toca cada nota del acorde en rÃ¡pida sucesiÃ³n (staccato juguetÃ³n)
                chord.forEach((note, index) => {
                    synth.triggerAttackRelease(note, '16n', time + index * 0.05);
                });
            }, [
                ["0:0:0", melody[0]],
                ["0:1:0", melody[1]],
                ["0:2:0", melody[2]],
                ["0:3:0", melody[3]],
            ]);

            part.loop = true;
            part.loopEnd = '4m';
            part.start(0);
            return part;
        };

        // 2. ðŸ˜” Tristeza (Sadness) - Lento, oscuro, legato
        const createTristezaTrack = () => {
            Tone.Transport.bpm.value = 50;
            const celloSynth = new Tone.FMSynth({
                harmonicity: 3.01,
                modulationIndex: 14,
                envelope: { attack: 0.8, decay: 1, sustain: 0.4, release: 4 }, // Ataque lento, Release largo
                modulation: { type: 'sine' },
                modulationEnvelope: { attack: 1.0, decay: 0.5, sustain: 0.2, release: 2 }
            }).toDestination();
            activeSynths.push(celloSynth);

            // MelodÃ­a descendente en Do Menor (Cm) con notas largas
            const part = new Tone.Part((time, note) => {
                celloSynth.triggerAttackRelease(note.note, note.duration, time);
            }, [
                { time: "0:0:0", note: "C3", duration: "1n" }, // 1 compÃ¡s
                { time: "1:0:0", note: "Bb2", duration: "2n" },
                { time: "1:2:0", note: "Ab2", duration: "2n" },
                { time: "2:0:0", note: "G2", duration: "1m" }, // 1 compÃ¡s de G2 (legato)
                { time: "3:0:0", note: "Eb2", duration: "1n" }
            ]);

            part.loop = true;
            part.loopEnd = '4m';
            part.start(0);
            return part;
        };

        // 3. ðŸ˜¨ Miedo (Fear) - Irregular, disonante, ruido
        const createMiedoTrack = () => {
            Tone.Transport.bpm.value = 90;
            const lowBass = new Tone.MonoSynth({
                oscillator: { type: 'sawtooth' },
                envelope: { attack: 0.05, decay: 0.1, sustain: 0.05, release: 0.1 },
                filterEnvelope: { attack: 0.1, decay: 0.01, sustain: 0.5, release: 0.5, baseFrequency: 60, octaves: 1 }
            }).toDestination();
            activeSynths.push(lowBass);

            const noise = new Tone.NoiseSynth({
                noise: { type: "white" },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0 } // Para el golpe de ruido
            }).toDestination();
            activeSynths.push(noise);

            const tensionStrings = new Tone.PolySynth(3, Tone.Synth, {
                oscillator: { type: 'sine' },
                envelope: { attack: 0.1, decay: 0.8, sustain: 0.9, release: 0.5 }
            }).toDestination();
            activeSynths.push(tensionStrings);

            // Secuencia con eventos errÃ¡ticos:
            const part = new Tone.Part((time, event) => {
                if (event.type === 'bass') {
                    lowBass.triggerAttackRelease(event.note, '8n', time, 0.8);
                } else if (event.type === 'cluster') {
                    tensionStrings.triggerAttackRelease(["E4", "F4", "F#4"], "1m", time, 0.4); // Cluster disonante
                } else if (event.type === 'glissando') {
                    // SimulaciÃ³n de glissando ascendente terminando en un chillido agudo
                    noise.triggerAttackRelease(1, time, 1); // Ruido sÃºbito
                    tensionStrings.triggerAttackRelease("A6", "16n", time + 0.1, 1);
                }
            }, [
                { time: "0:0:0", type: "bass", note: "C1" }, // C1: Pulso irregular 1
                { time: "0:1:2", type: "bass", note: "C1" }, // C1: Pulso irregular 2
                { time: "1:0:0", type: "cluster" },          // C2: Cluster disonante sostenido
                { time: "2:0:0", type: "silence" },          // C3: SILENCIO TENSO
                { time: "3:2:0", type: "glissando" }         // C4: Estallido Glissando
            ]);

            part.loop = true;
            part.loopEnd = '4m';
            part.start(0);
            return part;
        };

        // 4. ðŸ˜  Enojo (Anger) - Fuerte, distorsionado, percusivo
        const createEnojoTrack = () => {
            Tone.Transport.bpm.value = 160;

            // Efecto de DistorsiÃ³n
            const distortion = new Tone.Distortion(0.8).toDestination();

            // Guitarra (PolySynth con distorsiÃ³n)
            const guitar = new Tone.PolySynth(2, Tone.MonoSynth, {
                oscillator: { type: 'square' },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.1 }
            }).connect(distortion);
            activeSynths.push(guitar);

            // BaterÃ­a (MembraneSynth para bombo y caja)
            const kick = new Tone.MembraneSynth({ pitchDecay: 0.05, octave: 2, envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 } }).toDestination();
            const snare = new Tone.NoiseSynth({ envelope: { attack: 0.005, decay: 0.1, sustain: 0.0, release: 0.01 } }).toDestination();
            activeSynths.push(kick, snare);

            // MelodÃ­a RÃ­tmica (Power Riff)
            const riff = new Tone.Sequence((time, note) => {
                guitar.triggerAttackRelease(note, '8n', time, 1);
                kick.triggerAttackRelease("C1", '16n', time);
                // PatrÃ³n de Caja agresivo
                if (time.endsWith(':2:0') || time.endsWith(':3:0')) {
                    snare.triggerAttackRelease(0.5, time);
                }
            }, [
                ["E3", "B3"], ["E3", "B3"], ["F3", "C4"], ["F3", "C4"], // C1
                ["E3", "B3"], ["E3", "B3"], ["F3", "C4"], ["F3", "C4"], // C2
                ["E3", "B3"], ["rest"], ["F3", "C4"], ["rest"],        // C3 (Sincopado)
                ["E3", "B3"], ["E3", "B3"], ["F3", "C4"], ["F3", "C4"], // C4
            ], "8n").start(0);

            riff.loop = true;
            riff.loopEnd = '2m'; // Bucle de dos compases para el riff base
            return riff;
        };

        // 5. ðŸ˜Œ Calma (Calmness) - Lento, armÃ³nico, suave
        const createCalmaTrack = () => {
            Tone.Transport.bpm.value = 65;

            // 1. Pad Suave (AMSynth) para las armonÃ­as
            const pad = new Tone.AMSynth({
                harmonicity: 1.5,
                volume: -10,
                envelope: { attack: 2.0, decay: 0.5, sustain: 0.5, release: 4.0 }, // Ataque y Release lentos
            }).toDestination();
            activeSynths.push(pad);

            // 2. Flauta (Synth) para la melodÃ­a
            const flute = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 1.0, decay: 0.1, sustain: 0.8, release: 1.5 },
                volume: -5
            }).toDestination();
            activeSynths.push(flute);

            // ArmonÃ­a (Db Mayor)
            const harmony = new Tone.Part((time, chord) => {
                pad.triggerAttackRelease(chord, '4n', time);
            }, [
                ["0:0:0", ["Db3", "F3", "Ab3"]], // Dbmaj7
                ["1:0:0", ["C3", "Eb3", "Ab3"]], // Ab/C
                ["2:0:0", ["Bb2", "Db3", "F3"]], // Bbm7
                ["3:0:0", ["Gb2", "Bb2", "Db3"]] // Gbmaj7
            ]).start(0);

            // MelodÃ­a (Flauta Circular)
            const melody = new Tone.Part((time, note) => {
                flute.triggerAttackRelease(note, '1n', time); // Notas largas
            }, [
                { time: "0:0:0", note: "F4" },
                { time: "1:0:0", note: "Gb4" },
                { time: "2:0:0", note: "Ab4" },
                { time: "3:0:0", note: "Db5" }
            ]).start(0);

            harmony.loop = true;
            harmony.loopEnd = '4m';
            melody.loop = true;
            melody.loopEnd = '4m';

            return [harmony, melody];
        };

        // === FUNCIÃ“N PRINCIPAL ===

        const playEmotionTrack = async (emotion) => {
            await startAudioContext();
            stopAll();

            let trackCreator;
            let trackName;

            switch (emotion) {
                case 'alegria':
                    trackCreator = createAlegriaTrack;
                    trackName = 'AlegrÃ­a';
                    break;
                case 'tristeza':
                    trackCreator = createTristezaTrack;
                    trackName = 'Tristeza';
                    break;
                case 'miedo':
                    trackCreator = createMiedoTrack;
                    trackName = 'Miedo';
                    break;
                case 'enojo':
                    trackCreator = createEnojoTrack;
                    trackName = 'Enojo';
                    break;
                case 'calma':
                    trackCreator = createCalmaTrack;
                    trackName = 'Calma';
                    break;
                default:
                    console.error("EmociÃ³n no reconocida.");
                    return;
            }

            console.log(`Iniciando track: ${trackName}`);
            currentTrack = trackCreator(); // Puede ser un objeto o un array de objetos (Calma)
            Tone.Transport.start();
        };
    </script>

</body>
</html>